<h1>Your TripFlow Calendar</h1>

<button class="logout-btn" (click)="logout()">Logout</button>

@if (isHomePage) {
  <div class="add-day-container">
    <input type="date" [(ngModel)]="selectedDate" />
    <button class="add-day-btn" (click)="addDay()">+ Add New Day</button>
  </div>

  <div style="text-align:center; margin-bottom: 16px;">
    <label class="sort-text">
      <input class="sort-checkbox" type="checkbox" [(ngModel)]="sortRecentFirst" (change)="toggleSortRecent()"/>
      Show recent days first
    </label>
  </div>

  <div class="days-container">
    @for (day of days; track day.date) {
      <div class="day-tile" (click)="goToDay(day.date)">
        <h3>{{day.date}}</h3>
      </div>
    }
    @if (days.length === 0) {
      <p style="text-align: center; margin-top: 20px; color: #666;">No trips have been planned yet. Please add a day.</p>
    }
  </div>
}

@if (!isHomePage) {
  @for (day of days; track day.date) {
    <div class="day-card">
      <h3>{{day.date}} Schedule</h3>
      <div class="ai-row">
        <div class="ai-button-wrapper">
          <button class="ai-analyze-btn" (click)="analyzeCurrentDay(day)">
            Analyze with AI
          </button>

          @if (showAIAnalysisPopup) {
            <div class="ai-popup">
              <div class="ai-popup-header">
                <span>AI Trip Analysis</span>
                <button class="close-btn-x" (click)="closeAIPopup()">X</button>
              </div>
              <div class="ai-popup-body">
                @if(isAnalyzing) {
                  <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Analyzing your trip...</p>
                  </div>
                } @else {
                  <div class="ai-response-text"
                    [innerHTML]="formatAIResponse(aiAnalysisResult)">
                  </div>
                }
              </div>
            </div>
          }
         </div> 
        <button class="ai-autofill-btn" (click)="autofillCurrentDay(day)">
          Autofill with AI
        </button>
      </div>

      @if (isAutofilling) {
        <div class="ai-loading-inline">
          <div class="spinner-small"></div>
          <span>AI is planning your trip...</span>
        </div>
      }
   <div class="btn-row-container">
    <button class="delete-day-btn" (click)="deleteDay(day)">Delete Day</button>
   </div>

      <div class="add-activity-wrapper">
        <button class="add-activity-btn" *ngIf="!day.isEditingNew" (click)="toggleAddForm(day)">
          + Add Activity
        </button>
      </div>

      @if (day.isEditingNew) {
        <div class="activity-form" style="margin: 0 auto;">
          <input type="text" placeholder="Activity" [(ngModel)]="day.tempActivity!.name" />
          <input type="text" placeholder="Location" [(ngModel)]="day.tempActivity!.location" />
          <button type="button" class="map-btn" (click)="openMapForNewActivity(day)">Pick Location (Map)</button>
          <input type="time" [(ngModel)]="day.tempActivity!.start" />
          <input type="time" [(ngModel)]="day.tempActivity!.end" />
          <input type="number" placeholder="Expected cost" [(ngModel)]="day.tempActivity!.expectedCost" />
          <input type="number" placeholder="Actual cost" [(ngModel)]="day.tempActivity!.actualCost" />

          <button class="save-btn" (click)="saveActivity(day)">Save</button>
          <button type="button" class="cancel-btn" (click)="cancelAddActivity(day)">Cancel</button>
        </div>
      }

      <div class="activities-column" style="margin-top: 20px;">
        @for (act of day.activities; track act.id) {
          <div class="activity-summary">
              @if (!act.isEditing) {
                <strong>{{act.name}}</strong>
                <span class="activity-time"> <b>Time:</b> {{formatTime(act.start)}} - {{formatTime(act.end)}}</span>
                @if (act.location) {
                  <span class="activity-location"> <b>Location:</b> {{act.location}}</span>
                }
                <span class="activity-cost">
                  <b>Expected cost:</b> ${{act.expectedCost | number:'1.2-2'}}
                  @if (act.actualCost !== null && act.actualCost !== undefined) {
                    <b>Actual Cost:</b> ${{act.actualCost}}
                  }
                </span>
                <button class="weather-btn" (click)="openWeather(day, act.coords)">
                  ☀️ Weather
                </button>
                <div>
                  <button class="edit-btn" (click)="editActivity(act)">Edit</button>
                  <button class="delete-btn" (click)="deleteActivity(day, act)">Delete</button>
                </div>
              }
              @if (act.isEditing) {
                <input type="text" [(ngModel)]="act.temp!.name" placeholder="Activity" />
                <input type="text" [(ngModel)]="act.temp!.location" placeholder="Location" />
                <button type="button" class="map-btn" (click)="openMapForActivity(act)">Pick Location (Map)</button>
                <input type="time" [(ngModel)]="act.temp!.start" />
                <input type="time" [(ngModel)]="act.temp!.end" />
                <input type="number" [(ngModel)]="act.temp!.expectedCost" placeholder="Expected cost" />
                <input type="number" [(ngModel)]="act.temp!.actualCost" placeholder="Actual cost" />
                <div>
                  <button class="save-btn" (click)="saveEditedActivity(day, act)">Save</button>
                  <button class="cancel-btn" (click)="cancelEditActivity(act)">Cancel</button>
                </div>
              }
          </div>
        }
      </div>
    </div>
  }

  @for (day of showCurrentDay(); track day.date) {}
  <div class="day-summary" *ngFor="let day of showCurrentDay()">
    <h3>TripFlow Summary for the Day</h3>
    <div class="summary-stats">
      <p>
        <b>Expected:</b>
        ${{getExpectedTotalCost(day) | number:'1.2-2'}}
      </p>

      <p>
        <b>Actual:</b>
        ${{getActualTotalCost(day) | number:'1.2-2'}}
      </p>

      <p>
        <b>Difference:</b>
        {{getBudgetDifferencePercent(day) | number:'1.0-1'}}%
      </p>

      <p>
        <b>Planning Accuracy:</b>
        {{getPlanningAccuracyScore(day) * 100 | number:'1.0-0'}}%
      </p>

      <p>
        <b>Expected Cost Density:</b>
        ${{getExpectedCostDensity(day) | number:'1.2-2'}} / hour
      </p>

      <p>
        <b>Actual Cost Density:</b>
        ${{getActualCostDensity(day) | number:'1.2-2'}}
        / hour
      </p>
    </div>

    <div class="back-home-row">
        <button class="add-day-btn" [routerLink]="['/home']">Back to Home</button>
    </div>
  </div>
  }

<app-weather
  *ngIf="showWeatherPopup"
  [weatherData]="weatherData"
  [date]="weatherDate"
  [location]="weatherLocation"
  (close)="closeWeatherPopup() ">
</app-weather>