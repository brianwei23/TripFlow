<h1>My TripFlow Calendar</h1>

<button class="logout-btn" (click)="logout()">Logout</button>

@if (viewMode === 'trips') {
  <div class="trips-header">
    <h2>My Trips</h2>
    @if (!showCreateTripForm) {
      <button class="add-trip-btn" (click)="openCreateTripForm()">Create New Trip</button>
    }  
  </div>

  @if (showCreateTripForm) {
    <div class="create-trip-form">
      <input type="text" placeholder="Trip Name" [(ngModel)]="newTripName" />
      <button class="save-btn" (click)="createTrip()">Save</button>
      <button class="cancel-btn" (click)="closeCreateTripForm()">Cancel</button>
    </div>
  }

  <div style="text-align:center; margin-bottom: 16px;">
    <label class="sort-text">
      <input class="sort-checkbox" type="checkbox" [(ngModel)]="sortTripsOldestFirst" (change)="toggleSortTrips()" />
      Show oldest trips first
    </label>
  </div>

  <div class="days-container">
    @for (trip of trips; track trip.id) {
      <div class="day-tile" (click)="openTrip(trip)">
        <h3>{{trip.name}}</h3>
        @if (trip.dateRange) {
          <p class="trip-date-range"><b>{{formatDayLabel(trip.dateRange.start)}} — {{formatDayLabel(trip.dateRange.end)}}</b></p>
        } @else {
          <p class="trip-date-range trip-date-range--empty">No dates planned yet.</p>
        }
      </div>
    }
    @if (trips.length === 0) {
      <p style="text-align: center; margin-top: 20px; color: #666; width: 100%;">No trips here. Create one today!</p>
    }
  </div>
}

@if (viewMode === 'days') {
  <div class="days-header">
    <button class="back-btn" (click)="backToTrips()">Back to Trips</button>
    @if (!isEditingTripName) {
      <h2>{{selectedTrip?.name}} - Calendar</h2>
      <div class="header-actions"> <button class="edit-btn" (click)="startEditTripName()">Edit Name</button>
        <button
          class="delete-trip-btn"
          (click)="deleteTrip(selectedTrip!, $event)"
          style="background: #ff4d4d; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; margin-left: 8px;">
          Delete Trip
        </button>
      </div>
    } @else {
      <input type="text" [(ngModel)]="editTripNameValue" />
      <button class="save-btn" (click)="saveEditTripName()">Save</button>
      <button class="cancel-btn" (click)="cancelEditTripName()">Cancel</button>
    }
  </div>

  <div class="add-day-container">
    <input type="date" [(ngModel)]="selectedDate" />
    <button class="add-day-btn" (click)="addDay()">+ Add New Day</button>
  </div>

  <div class="add-date-range-container" style="text-align: center; margin-bottom: 20px;">
    <span>Or create a date range: </span>
    <input type="date" [(ngModel)]="startDateRange" />
    <span> to </span>
    <input type="date" [(ngModel)]="endDateRange" />
    <button class="add-day-btn" (click)="createDateRange()" style="margin-left: 10px;">Create Date Range</button>
  </div>

  <div class="add-general-days-container" style="text-align: center; margin-bottom: 20px;">
    <span>Or create general days: Day</span>
    <input
      type="number"
      [(ngModel)]="generalDayStart"
      min="1"
      style="width: 60px; padding: 6px; border-radius: 4px; border: 1px solid #ccc;"
    />
    <span>to Day</span>
    <input
      type="number"
      [(ngModel)]="generalDayEnd"
      min="1"
      style="width: 60px; padding: 6px; border-radius: 4px; border: 1px solid #ccc;"
    />
    <button class="add-day-btn" (click)="createGeneralDayRange()" style="margin-left: 10px;">Create Days</button>
  </div>

  <div class="create-ai-trip-container" style="text-align: center; margin-bottom: 20px;">
    <input
      type="text"
      [(ngModel)]="aiTripLocation"
      placeholder="Location (required)"
      style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 200px;"
    />
    <button class="add-day-btn" (click)="createAITrip()" style="margin-left: 10px;">
      Create AI Trip
    </button>
    @if (isCreatingAITrip) {
      <div style="margin-top: 10px;">
        <div class="spinner-small" style="display: inline-block;"></div>
        <span>AI is planning your whole trip...</span>
      </div>
    }
  </div>

  <div style="text-align:center; margin-bottom: 16px;">
    <label class="sort-text">
      <input class="sort-checkbox" type="checkbox" [(ngModel)]="sortRecentFirst" (change)="toggleSortRecent()"/>
      Show recent days first
    </label>
  </div>

  <div class="days-container">
    @for (day of days; track day.date) {
      <div class="day-tile" (click)="goToDay(day.date)">
        <h3>{{formatDayLabel(day.date)}}</h3>
      </div>
    }
    @if (days.length === 0) {
      <p style="text-align: center; margin-top: 20px; color: #666; width: 100%;">No days planned yet.</p>
    }
  </div>
}

@if (viewMode === 'day-detail') {
  @for (day of showCurrentDay(); track day.date) {
    <div class="day-card">
      <div class="days-header">
        @if (!isEditingDayDate) {
          <h3>{{formatDayLabel(day.date)}} Schedule</h3>
          <button class="edit-btn" (click)="startEditDayDate(day)">Edit Date</button>
        } @else {
          <input type="date" [(ngModel)]="editDayDateValue" />
          <button class="save-btn" (click)="saveEditDayDate(day)">Save</button>
          <button class="cancel-btn" (click)="cancelEditDayDate()">Cancel</button>
        }  
      </div>

      <div class="ai-row">
        <div class="ai-button-wrapper">
          <button class="ai-analyze-btn" (click)="analyzeCurrentDay(day)">
            Analyze with AI
          </button>

          @if (showAIAnalysisPopup) {
            <div class="ai-popup">
              <div class="ai-popup-header">
                <span>AI Trip Analysis</span>
                <button class="close-btn-x" (click)="closeAIPopup()">X</button>
              </div>
              <div class="ai-popup-body">
                @if (isAnalyzing) {
                  <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Analyzing your trip...</p>
                  </div>
                } @else {
                  <div class="ai-response-text" [innerHTML]="formatAIResponse(aiAnalysisResult)"></div>
                }
              </div>
            </div>
          }
        </div> 

        <div class="ai-controls" style="margin: 20px 0; display: flex; gap: 10px; justify-content: center;">
          <input
            type="text"
            [(ngModel)]="autofillLocation"
            placeholder="Enter location (optional)"
            class="location-input"
            style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 200px;"
          />
        <button class="ai-autofill-btn" (click)="autofillCurrentDay(day)">
          Autofill with AI
        </button>
        </div>
      </div>

      @if (isAutofilling) {
        <div class="ai-loading-inline">
          <div class="spinner-small"></div>
          <span>AI is planning your trip...</span>
        </div>
      }

      <div class="btn-row-container">
        <button class="delete-day-btn" (click)="deleteDay(day)">Delete Day</button>
      </div>

      <div class="add-activity-wrapper">
        @if (!day.isEditingNew) {
          <button class="add-activity-btn" (click)="toggleAddForm(day)">
            + Add Activity
          </button>
        }
      </div>

      @if (day.isEditingNew) {
        <div class="activity-form" style="margin: 0 auto;">
          <input type="text" placeholder="Activity" [(ngModel)]="day.tempActivity!.name" />
          <input type="text" placeholder="Location" [(ngModel)]="day.tempActivity!.location" />
          <button type="button" class="map-btn" (click)="openMapForNewActivity(day)">Pick Location (Map)</button>
          <input type="time" [(ngModel)]="day.tempActivity!.start" />
          <input type="time" [(ngModel)]="day.tempActivity!.end" />
          <input type="number" placeholder="Expected cost" [(ngModel)]="day.tempActivity!.expectedCost" />
          <input type="number" placeholder="Actual cost" [(ngModel)]="day.tempActivity!.actualCost" />

          <button class="save-btn" (click)="saveActivity(day)">Save</button>
          <button type="button" class="cancel-btn" (click)="cancelAddActivity(day)">Cancel</button>
        </div>
      }

      <div class="activities-column" style="margin-top: 20px;">
        @for (act of day.activities; track act.id) {
          <div class="activity-summary">
              @if (!act.isEditing) {
                <strong>{{act.name}}</strong>
                <span class="activity-time"> <b>Time:</b> {{formatTime(act.start)}} - {{formatTime(act.end)}}</span>
                @if (act.location) {
                  <span class="activity-location"> <b>Location:</b> {{act.location}}</span>
                }
                <span class="activity-cost">
                  <b>Expected cost:</b> ${{act.expectedCost | number:'1.2-2'}}
                  @if (act.actualCost !== null && act.actualCost !== undefined) {
                    <b>Actual Cost:</b> ${{act.actualCost}}
                  }
                </span>
                <button class="weather-btn" (click)="openWeather(day, act.coords)">
                  ☀️ Weather
                </button>
                <div>
                  <button class="edit-btn" (click)="editActivity(act)">Edit</button>
                  <button class="delete-btn" (click)="deleteActivity(day, act)">Delete</button>
                </div>
              }
              @else {
                <input type="text" [(ngModel)]="act.temp!.name" placeholder="Activity" />
                <input type="text" [(ngModel)]="act.temp!.location" placeholder="Location" />
                <button type="button" class="map-btn" (click)="openMapForActivity(act)">Pick Location (Map)</button>
                <input type="time" [(ngModel)]="act.temp!.start" />
                <input type="time" [(ngModel)]="act.temp!.end" />
                <input type="number" [(ngModel)]="act.temp!.expectedCost" placeholder="Expected cost" />
                <input type="number" [(ngModel)]="act.temp!.actualCost" placeholder="Actual cost" />
                <div>
                  <button class="save-btn" (click)="saveEditedActivity(day, act)">Save</button>
                  <button class="cancel-btn" (click)="cancelEditActivity(act)">Cancel</button>
                </div>
              }
          </div>
        }
      </div>
    </div>

    <div class="day-summary">
      <h3>TripFlow Summary for the Day</h3>
      <div class="summary-stats">
        <p><b>Expected:</b> ${{getExpectedTotalCost(day) | number:'1.2-2'}}</p>
        <p><b>Actual:</b> ${{getActualTotalCost(day) | number:'1.2-2'}}</p>
        <p><b>Difference:</b> {{getBudgetDifferencePercent(day) | number:'1.0-1'}}%</p>
        <p><b>Planning Accuracy:</b> {{getPlanningAccuracyScore(day) * 100 | number:'1.0-0'}}%</p>
        <p><b>Expected Cost Density:</b> ${{getExpectedCostDensity(day) | number:'1.2-2'}} / hour</p>
        <p><b>Actual Cost Density:</b> ${{getActualCostDensity(day) | number:'1.2-2'}} / hour</p>
      </div>
      <div class="back-home-row">
          <button class="add-day-btn" (click)="backToDays()">Back to Trip Calendar</button>
      </div>
    </div>
  }
}

@if (showWeatherPopup) {
  <app-weather
    [weatherData]="weatherData"
    [date]="weatherDate"
    [location]="weatherLocation"
    (close)="closeWeatherPopup()">
  </app-weather>
}  